<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Booking Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-container {
            height: 500px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: #0284c7;
            border-radius: 10px;
        }
        
        .message-enter {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .typing-indicator span {
            animation: blink 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes blink {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        
        .assistant-btn {
            box-shadow: 0 4px 12px rgba(2, 132, 199, 0.4);
            transition: all 0.3s ease;
        }
        
        .assistant-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(2, 132, 199, 0.6);
        }
        
        .chat-window {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hall-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .hall-card:hover {
            border-color: #0284c7;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Floating Assistant Button -->
    <button id="assistantBtn" class="assistant-btn fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-full flex items-center justify-center z-50 focus:outline-none">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
        </svg>
    </button>

    <!-- Chat Window -->
    <div id="chatWindow" class="chat-window fixed bottom-24 right-6 w-96 bg-white rounded-2xl shadow-2xl z-50 hidden overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="font-semibold text-lg">VenueVista AI</h3>
                    <p class="text-xs text-blue-100">Your booking assistant</p>
                </div>
            </div>
            <button id="closeChat" class="hover:bg-white/20 rounded-full p-1 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="chat-container p-4 bg-gray-50 space-y-3">
            <div class="message-enter flex items-start space-x-2">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div class="bg-white rounded-2xl rounded-tl-none p-3 shadow-sm max-w-xs">
                    <p class="text-sm text-gray-800">Hello! I'm your VenueVista AI assistant. Tell me about your event - the date, time, number of attendees, address, and purpose. I'll find the perfect venue for you!</p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-gray-200">
            <div class="flex space-x-2">
                <input 
                    id="messageInput" 
                    type="text" 
                    placeholder="Describe your event needs..." 
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
                <button id="sendBtn" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        class BookingAssistant {
            constructor() {
                this.apiUrl = 'http://localhost:3000';
                this.groqApiKey = 'HELLO';
                this.userId = window.localStorage.getItem('userId') || '1';
                this.currentUser = null;
                this.availableHalls = [];
                this.bookings = [];
                
                this.initializeElements();
                this.setupEventListeners();
                this.loadUserData();
            }

            initializeElements() {
                this.assistantBtn = document.getElementById('assistantBtn');
                this.chatWindow = document.getElementById('chatWindow');
                this.closeChat = document.getElementById('closeChat');
                this.chatMessages = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
            }

            setupEventListeners() {
                this.assistantBtn.addEventListener('click', () => this.toggleChat());
                this.closeChat.addEventListener('click', () => this.toggleChat());
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            }

            toggleChat() {
                this.chatWindow.classList.toggle('hidden');
                if (!this.chatWindow.classList.contains('hidden')) {
                    this.messageInput.focus();
                }
            }

            async loadUserData() {
                try {
                    const [userRes, bookingsRes, hallsRes] = await Promise.all([
                        fetch(`${this.apiUrl}/users/${this.userId}`),
                        fetch(`${this.apiUrl}/bookings`),
                        fetch(`${this.apiUrl}/halls`)
                    ]);

                    this.currentUser = await userRes.json();
                    this.bookings = await bookingsRes.json();
                    this.availableHalls = await hallsRes.json();
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            }

            addMessage(text, isUser = false, isHtml = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message-enter flex items-start space-x-2 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
                
                const avatar = document.createElement('div');
                avatar.className = `w-8 h-8 ${isUser ? 'bg-gray-600' : 'bg-blue-500'} rounded-full flex items-center justify-center flex-shrink-0`;
                avatar.innerHTML = isUser 
                    ? '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>'
                    : '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>';

                const bubble = document.createElement('div');
                bubble.className = `${isUser ? 'bg-blue-500 text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none'} rounded-2xl p-3 shadow-sm max-w-xs`;
                
                if (isHtml) {
                    bubble.innerHTML = text;
                } else {
                    bubble.innerHTML = `<p class="text-sm">${text}</p>`;
                }

                messageDiv.appendChild(avatar);
                messageDiv.appendChild(bubble);
                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            showTypingIndicator() {
                const typing = document.createElement('div');
                typing.id = 'typingIndicator';
                typing.className = 'message-enter flex items-start space-x-2';
                typing.innerHTML = `
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div class="bg-white rounded-2xl rounded-tl-none p-3 shadow-sm">
                        <div class="typing-indicator flex space-x-1">
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                        </div>
                    </div>
                `;
                this.chatMessages.appendChild(typing);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            hideTypingIndicator() {
                const typing = document.getElementById('typingIndicator');
                if (typing) typing.remove();
            }

            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message) return;

                this.addMessage(message, true);
                this.messageInput.value = '';
                this.showTypingIndicator();

                try {
                    await this.processBookingRequest(message);
                } catch (error) {
                    this.hideTypingIndicator();
                    this.addMessage('Sorry, I encountered an error. Please try again.');
                    console.error('Error:', error);
                }
            }

            async processBookingRequest(userMessage) {
                const extractedInfo = await this.extractBookingInfo(userMessage);

                if (!extractedInfo.isComplete) {
                    this.hideTypingIndicator();
                    this.addMessage(extractedInfo.message);
                    return;
                }

                const availableRooms = this.findAvailableRooms(
                    extractedInfo.date,
                    extractedInfo.checkInTime,
                    extractedInfo.checkOutTime,
                    extractedInfo.capacity
                );

                this.hideTypingIndicator();

                if (availableRooms.length === 0) {
                    this.addMessage('Sorry, no rooms are available for your requested date and time. Please try different dates or times.');
                    return;
                }

                this.displayAvailableRooms(availableRooms, extractedInfo);
            }

            convertTo24Hour(time) {
                const timeStr = time.toString().toLowerCase().trim();
                
                // If already in 24-hour format
                if (/^\d{1,2}:\d{2}$/.test(timeStr) && !timeStr.includes('am') && !timeStr.includes('pm')) {
                    const [h, m] = timeStr.split(':');
                    return `${h.padStart(2, '0')}:${m}`;
                }
                
                // Handle AM/PM format
                const match = timeStr.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)/i);
                if (match) {
                    let hours = parseInt(match[1]);
                    const minutes = match[2] || '00';
                    const period = match[3].toLowerCase();
                    
                    if (period === 'pm' && hours !== 12) hours += 12;
                    if (period === 'am' && hours === 12) hours = 0;
                    
                    return `${hours.toString().padStart(2, '0')}:${minutes}`;
                }
                
                // Handle simple number format (e.g., "10")
                const numMatch = timeStr.match(/^(\d{1,2})$/);
                if (numMatch) {
                    const hours = parseInt(numMatch[1]);
                    return `${hours.toString().padStart(2, '0')}:00`;
                }
                
                return null;
            }

            async extractBookingInfo(message) {
                try {
                    const systemPrompt = `You are a JSON extraction bot. Extract booking details from user messages and return ONLY valid JSON.

                                Current date: September 29, 2025

                                Rules:
                                - date: Format as YYYY-MM-DD (e.g., "September 30" becomes "2025-09-30", "Oct 5" becomes "2025-10-05")
                                - checkInTime: 24-hour format HH:MM (e.g., "10 AM" = "10:00", "2 PM" = "14:00")
                                - checkOutTime: 24-hour format HH:MM (e.g., "2 PM" = "14:00", "5 PM" = "17:00")
                                - capacity: Integer only (e.g., "35 people" = 35)
                                - address: Full address string
                                - purpose: Event description

                                Return JSON ONLY. No explanations.`;

                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.groqApiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'llama-3.1-8b-instant',
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: `Extract from: "${message}"` }
                            ],
                            temperature: 0,
                            max_tokens: 300
                        })
                    });

                    const data = await response.json();
                    let content = data.choices[0].message.content.trim();
                    
                    // Remove markdown code blocks
                    content = content.replace(/```json\s*/g, '').replace(/```\s*/g, '');
                    
                    const result = JSON.parse(content);
                    
                    // Convert times if needed
                    if (result.checkInTime) {
                        const converted = this.convertTo24Hour(result.checkInTime);
                        if (converted) result.checkInTime = converted;
                    }
                    if (result.checkOutTime) {
                        const converted = this.convertTo24Hour(result.checkOutTime);
                        if (converted) result.checkOutTime = converted;
                    }
                    
                    // Check completeness
                    result.isComplete = !!(result.date && result.checkInTime && result.checkOutTime && 
                                          result.capacity && result.address && result.purpose);
                    
                    if (!result.isComplete) {
                        const missing = [];
                        if (!result.date) missing.push('date');
                        if (!result.checkInTime) missing.push('check-in time');
                        if (!result.checkOutTime) missing.push('check-out time');
                        if (!result.capacity) missing.push('number of attendees');
                        if (!result.address) missing.push('address');
                        if (!result.purpose) missing.push('purpose');
                        
                        result.message = `I need more information: ${missing.join(', ')}. Please provide all details.`;
                    }

                    return result;
                } catch (error) {
                    console.error('Extraction error:', error);
                    return {
                        isComplete: false,
                        message: 'Could not process your request. Please provide: date, check-in time, check-out time, number of attendees, address, and purpose.'
                    };
                }
            }

            findAvailableRooms(date, checkInTime, checkOutTime, capacity) {
                let category;
                if (capacity <= 20) category = 'Compact Hall';
                else if (capacity <= 50) category = 'Classic Hall';
                else category = 'Grand Hall';

                const hall = this.availableHalls.find(h => h.name === category);
                if (!hall) return [];

                const availableRooms = hall.rooms.filter(room => {
                    const isBooked = this.bookings.some(booking => {
                        return booking.roomId === room.roomNumber &&
                               booking.date === date &&
                               booking.status !== 'cancelled' &&
                               this.timesOverlap(
                                   checkInTime, checkOutTime,
                                   booking.checkInTime, booking.checkOutTime
                               );
                    });
                    return !isBooked && room.status === 'active';
                });

                return availableRooms.map(room => ({
                    ...room,
                    hall: hall,
                    category: category
                }));
            }

            timesOverlap(start1, end1, start2, end2) {
                return start1 < end2 && start2 < end1;
            }

            displayAvailableRooms(rooms, bookingInfo) {
                const room = rooms[0];
                const duration = this.calculateDuration(bookingInfo.checkInTime, bookingInfo.checkOutTime);
                const totalCost = room.hall.pricePerHour * duration;

                const hallHtml = `
                    <div class="text-sm space-y-3">
                        <p class="font-semibold text-gray-800">Perfect! I found a great option for you:</p>
                        <div class="hall-card bg-gradient-to-br from-blue-50 to-white rounded-xl p-3 border border-blue-200">
                            <img src="${room.image}" alt="${room.hall.name}" class="w-full h-32 object-cover rounded-lg mb-2">
                            <h4 class="font-bold text-gray-800">${room.hall.name}</h4>
                            <p class="text-xs text-gray-600">Room ${room.roomNumber}</p>
                            <p class="text-xs text-gray-600 mt-1">Capacity: ${room.hall.capacity} people</p>
                            <p class="text-xs text-gray-600">Duration: ${duration} hour(s)</p>
                            <p class="font-bold text-blue-600 mt-2">â‚¹${totalCost.toLocaleString()}</p>
                            <div class="mt-2 flex flex-wrap gap-1">
                                ${room.hall.amenities.slice(0, 3).map(a => `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${a}</span>`).join('')}
                            </div>
                        </div>
                        <button 
                            onclick="bookingAssistant.confirmBooking(${JSON.stringify(room).replace(/"/g, '&quot;')}, ${JSON.stringify(bookingInfo).replace(/"/g, '&quot;')}, ${totalCost})"
                            class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 rounded-lg font-semibold hover:from-blue-600 hover:to-blue-700 transition-all">
                            Confirm Booking
                        </button>
                    </div>
                `;

                this.addMessage(hallHtml, false, true);
            }

            calculateDuration(checkIn, checkOut) {
                const [h1, m1] = checkIn.split(':').map(Number);
                const [h2, m2] = checkOut.split(':').map(Number);
                return Math.max(1, Math.ceil(((h2 * 60 + m2) - (h1 * 60 + m1)) / 60));
            }

            async confirmBooking(room, bookingInfo, totalCost) {
                this.showTypingIndicator();

                try {
                    const booking = {
                        userId: parseInt(this.userId),
                        date: bookingInfo.date,
                        checkInTime: bookingInfo.checkInTime,
                        checkOutTime: bookingInfo.checkOutTime,
                        venueCategory: room.category.toLowerCase().split(' ')[0],
                        roomId: room.roomNumber,
                        firstName: this.currentUser.firstName,
                        lastName: this.currentUser.lastName,
                        email: this.currentUser.email,
                        mobileNumber: this.currentUser.phone,
                        address: bookingInfo.address,
                        purpose: bookingInfo.purpose,
                        beverage: 'no',
                        beverages: {},
                        BookedOn: new Date().toLocaleDateString('en-GB'),
                        totalCost: totalCost,
                        status: 'booked'
                    };

                    const response = await fetch(`${this.apiUrl}/bookings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(booking)
                    });

                    if (response.ok) {
                        const newBooking = await response.json();
                        this.bookings.push(newBooking);
                        this.hideTypingIndicator();
                        this.addMessage(`ðŸŽ‰ Success! Your booking for ${room.hall.name}, Room ${room.roomNumber} has been confirmed for ${bookingInfo.date}. You can view it in your bookings page. Total cost: â‚¹${totalCost.toLocaleString()}`);
                    } else {
                        throw new Error('Booking failed');
                    }
                } catch (error) {
                    this.hideTypingIndicator();
                    this.addMessage('Sorry, there was an error processing your booking. Please try again or book manually.');
                    console.error('Booking error:', error);
                }
            }
        }

        const bookingAssistant = new BookingAssistant();
    </script>
</body>
</html>